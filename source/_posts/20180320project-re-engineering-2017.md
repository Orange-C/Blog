---
title: 记一次项目重构
date: 2018-03-20 14:52:30
categories: notes
tags:
- JavaScript
- React
- Koa
- Reengineering
---

## 前言

为什么要写这么一篇好像和业务关系比较大的博客呢？一方面这算是去年的主要工作，前前后后加上探索和收尾大概花了5个月的时间（除了中间正式迁移的一个月之外，其他时间都是和日常业务开发并行一起在做），打算好好写一下就当是去年的工作小结了，另一方面，这次重构的确给我带来了很大的提升，想写一下学到的东西，不光是技术方面的探索，还有看问题的角度，以及在重构工作中各个阶段的把控，都学到了很多东西，有些可能可以水一篇博客出来，有读者感兴趣的话再写吧（逃）。

所以这篇文章可能有那么一点碎碎念，我会尽量提取一些关键的内容在各章节的开始部分。

<!-- more -->

## 重构之前

后续部分中会将项目简称rainbow。rainbow技术上是一个前端基于react，中台基于koa的内部项目，中台node对接数据端API。因为历史原因，rainbow包含了rainbow-red，rainbow-yellow，rainbow-blue等多个项目用于支持不同的业务线，每个都是独立的node服务和前端页面，但是各个项目之间功能又大同小异，维护和扩展一直以来基本是靠复制粘贴，要开新业务线就要复制一个项目，然后花费大量时间改耦合部分，同理在新业务线中开功能也是这个步骤。

这次重构的宏观目标就是把rainbow-red，rainbow-yellow，rainbow-blue多个项目合并成为rainbow-platform，统一维护功能模块，同时实现业务线的快速扩展。

## 一切开始之前——基础设施改善

> 工欲善其事，必先利其器

一个优秀的项目应该是从本地开发到上线整个流程都有良好的体验，这样才能在后续的开发和重构工作中获得更高的效率。

### 本地开发环境

优秀的开发环境应该包含以下几点：
1. 一键搭建
2. 开发时编译时间占比小
2. 方便调试

#### 项目开发环境

因为历史原因，最大的rainbow项目在webpack编译时大概有4000多个module，用的还是webpack1和很老的配置，初次打包和rebuild都需要好几分钟，基本是处于一个开发十分不方便的状态。而且因为用的是dev-middleware，有时候在需要只调试node代码的时候，每次node重启都会进行webpack编译，十分浪费时间。

将webpack从1升级到了3，用dll拆出了公共模块放在cdn上，用来加快编译，还做了一些资源拆分和异步加载，加上了hash值缓存等等，大部分还是一些webpack配置工程师的活。说实话webpack一直被人诟病配置麻烦，主要还是黑盒式的配置加上自由度太大，导致很多东西文档实在写不全（不过webpack的文档的确有点糟糕），多看看相关文章积累经验后面就轻车熟路了，不算什么有技术难度的事情。

一顿操作下来本地开发初次build大概在40秒左右，rebuild3秒左右，本来还打算修复hotReload，但是因为当时react-hot-loader问题有点多，而且开会讨论之后大部分人觉得有了hotReload不太方便在chrome上面调试样式，所以就没做了。

然后加入了nobuild模式，配合node的--inspect和vscode的调试工具，调试node的体验也是大大提升。

#### 组件开发环境

团队内有一些公共组件是以npm包的形式放在内部npm上的，但是基本不能本地开发，之前的开发都是靠发布到npm上再下载下来调试，以至于出现了99.0.124这种神奇的版本号。而且每个组件都打包了所有依赖到index.js中，以至于每个组件大概都有1m左右。

首先用项目配置里的loader配置同样做了一份用于组件的webpack配置，支持本地watch rebuild，不打包外部依赖，最后生成umd规范的组件和对应的css文件，然后是分享了一下npm link/unlink的开发模式以及package.json中peerdependence、dependence、devDependence的用法，版本号的规范根据[Semantic Versioning 2.0.0](http://semver.org/lang/zh-CN/)，并要求组件发布要写CHANGELOG。

这样下来公共组件总算是有序了一点，最近打算将各个视图组件和antd一样统一起来，用babel-plugin-import实现按需加载。

#### 内部脚手架

在上面两份配置成熟之后用对应配置写了一个脚手架工具rainbow-init，用于快速生成新项目，这样算是统一了各个项目的开发环境配置。

### 构建和部署

体验良好的部署流程应该是一键式黑盒式的，不需要开发者关心部署的环境问题，部署顺序问题。

首先是同步了各个机器的环境，包括node版本和pm2版本等等（顺便修复了node7.6版本导致的内存泄漏问题）。公司内部机器的部署工具主要是用于后端服务的，所以对前端的部署不太友好，之前也是一直没有区分前端和node的部署，都是直接机器上强覆盖重启。

我重新写了一下构建和部署的shell和node脚本，前端静态资源自动发布到内部cdn上，加上了html部署的流程，保留了原来node服务部署的流程。这样倚赖就能做到前端和node的分开部署，也防止了前端部署代码导致node服务重启的问题。部署流程如下：

* 前端：静态资源发布cdn，html部署
* node：node代码全量覆盖，重启服务

### 整合工具

最后将上述的所有配置和脚本整合到了rainbow-tools里面，所有项目和组件直接依赖这个包，做了一个强统一。不过所有配置都支持传自定义配置覆盖默认，以便部分项目的特殊需求。

到此为止基本项目的开发和部署体验已经满足了大部开发者的需求，并且也做到了统一的管理，在重写配置的时候顺便解决了资源加载问题和一些bug，可以说项目质量和团队的整体开发效率都有了很大的提升。

## 重写基础模块



## 在小型项目中探索架构



## 正式迁移 && 路由问题
## 后期收尾